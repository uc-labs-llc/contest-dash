<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Systems Tester (Greenhouse Fan & Sprinklers)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <style>
        /* Custom styles for the dark theme and LED status */
        .led-off {
            color: #d1d5db; /* Gray */
            text-shadow: none;
        }
        .led-on-green {
            color: #10b981; /* Green */
            text-shadow: 0 0 5px rgba(16, 185, 129, 0.7);
        }
        .led-on-blue {
            color: #3b82f6; /* Blue */
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.7);
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="max-w-xl w-full mx-auto bg-gray-900 p-8 rounded-xl shadow-2xl border border-gray-700">
        <h2 class="text-3xl font-extrabold mb-6 text-white text-center">
            IoT Systems Test Environment & Email Alerts
        </h2>
        
        <div class="mb-8 text-center">
            <button id="toggle-test-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 w-full text-lg">
                Start API Test
            </button>
        </div>

        <div class="mb-6 p-6 border border-gray-700 rounded-lg bg-gray-800">
            <h3 class="text-xl font-bold mb-3 text-white">
                <i class="fas fa-fan text-green-500 mr-2"></i> Greenhouse Fan System (Alerts on: ON)
            </h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-sm text-gray-400">Current Temperature</p>
                    <p class="text-2xl font-semibold mt-1">
                        <span id="current-temp" class="text-blue-400">--</span><span class="text-gray-400">Â°F</span>
                    </p>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-sm text-gray-400">Fan Threshold</p>
                    <p class="text-2xl font-semibold mt-1 text-red-400">85<span class="text-gray-400">Â°F</span></p>
                </div>
            </div>
            <div class="p-3 border border-gray-600 rounded-lg bg-gray-700 flex items-center justify-between">
                <p class="font-medium text-gray-300 text-lg">FAN Status:</p>
                <span id="fan-status" class="text-xl font-bold led-off">OFF</span>
            </div>
        </div>

        <div class="mb-6 p-6 border border-gray-700 rounded-lg bg-gray-800">
            <h3 class="text-xl font-bold mb-3 text-white">
                <i class="fas fa-tint text-blue-500 mr-2"></i> Irrigation System (Alerts on: ON)
            </h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-sm text-gray-400">Current Rainfall</p>
                    <p class="text-2xl font-semibold mt-1">
                        <span id="current-rainfall" class="text-blue-400">--</span><span class="text-gray-400"> in.</span>
                    </p>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-sm text-gray-400">Stop Threshold</p>
                    <p class="text-2xl font-semibold mt-1 text-blue-400">0.50<span class="text-gray-400"> in.</span></p>
                </div>
            </div>
            <div class="p-3 border border-gray-600 rounded-lg bg-gray-700 flex items-center justify-between">
                <p class="font-medium text-gray-300 text-lg">SPRINKLER Status:</p>
                <span id="sprinkler-status" class="text-xl font-bold led-off">OFF</span>
            </div>
        </div>

        <h3 class="text-lg font-semibold mb-2 text-gray-300">Transaction Log:</h3>
        <textarea id="log-output" class="w-full h-40 p-3 border border-gray-600 rounded-md text-sm font-mono bg-gray-900 text-green-400 resize-none" readonly>System ready. Press "Start API Test" to begin Beeceptor.com API CALL.</textarea>
        
        <p class="text-xs text-gray-500 mt-3 text-center">
            Beeceptor (IoT API) calls are primary. PHP handler (Email) calls are secondary.
        </p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const FAN_URL = 'https://greenhouse-fan-mock.free.beeceptor.com/api/fan_control'; 
        const SPRINKLER_URL = 'https://greenhouse-fan-mock.free.beeceptor.com/api/sprinkler_control';
        const EMAIL_HANDLER_URL = 'send_iot_alert.php'; // ðŸš¨ NEW: Path to your PHP script
        
        const TEMP_THRESHOLD = 85; 
        const RAINFALL_THRESHOLD = 0.50; 
        const CHECK_INTERVAL = 5000; // 5 seconds

        // DOM Elements (same as before)
        const currentTempEl = document.getElementById('current-temp');
        const fanStatusEl = document.getElementById('fan-status');
        const currentRainfallEl = document.getElementById('current-rainfall');
        const sprinklerStatusEl = document.getElementById('sprinkler-status');
        const logOutputEl = document.getElementById('log-output');
        const toggleButton = document.getElementById('toggle-test-btn'); 

        let fanState = 'OFF';           
        let sprinklerState = 'OFF';     
        let intervalId = null;          

        // --- UTILITY FUNCTIONS ---

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            
            if (isError) {
                logMessage = `ðŸš¨ ERROR: ${logMessage}`;
            }

            logOutputEl.value += `\n${logMessage}`;
            logOutputEl.scrollTop = logOutputEl.scrollHeight;
        }

        function updateFanStatusDisplay(state) {
            fanStatusEl.textContent = state;
            fanStatusEl.classList.toggle('led-on-green', state === 'ON');
            fanStatusEl.classList.toggle('led-off', state === 'OFF');
        }

        function updateSprinklerStatusDisplay(state) {
            sprinklerStatusEl.textContent = state;
            sprinklerStatusEl.classList.toggle('led-on-blue', state === 'ON');
            sprinklerStatusEl.classList.toggle('led-off', state === 'OFF');
        }
        
        // --- NEW: EMAIL ALERT FUNCTION ---
        function sendEmailAlert(device, status, message) {
            log(`EMAIL: Attempting to send alert for ${device} status: ${status}...`);
            
            fetch(EMAIL_HANDLER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    device: device,
                    status: status,
                    message: message 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    log(`EMAIL: Success. ${data.message}`);
                } else {
                    log(`EMAIL: Failed. ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`EMAIL: Network Error calling PHP handler: ${error.message}. (Server must be running PHP)`, true);
            });
        }
        // ---------------------------------


        // --- API CALL FUNCTIONS (MODIFIED TO INCLUDE EMAIL) ---

        function sendFanCommand(state, temp) {
            const actionPayload = {
                command: state,
                reason: state === 'ON' ? 'Temperature above 85F threshold' : 'Temperature stabilized below 85F',
                current_temp: temp.toFixed(1),
                system_id: 'Greenhouse-Controller-1', 
                timestamp: new Date().toISOString()
            };

            fetch(FAN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-System-Source': 'Fan-Tester' },
                body: JSON.stringify(actionPayload)
            })
            .then(response => {
                if (response.ok) {
                    log(`FAN: SUCCESS [${state}] sent to Beeceptor. HTTP ${response.status}`);
                    fanState = state; 
                    updateFanStatusDisplay(state); 
                    
                    // ðŸš¨ Trigger Email Alert for critical ON status
                    if (state === 'ON') { 
                         sendEmailAlert('Greenhouse Fan', state, `Temperature reached ${temp.toFixed(1)}Â°F.`);
                    }
                    
                } else {
                    log(`FAN: ERROR [${state}] failed. HTTP ${response.status}.`, true);
                }
                return response.json();
            })
            .then(data => { log(`FAN: Mock Response: ${JSON.stringify(data)}`); })
            .catch(error => { log(`FAN: Network Error: ${error.message}`, true); });
        }

        function sendSprinklerCommand(state, rainfall) {
            const actionPayload = {
                command: state,
                reason: state === 'ON' ? 'Rainfall below 0.50in threshold' : 'Rainfall sufficient, stopping irrigation',
                current_rainfall: rainfall.toFixed(2),
                threshold: RAINFALL_THRESHOLD.toFixed(2),
                system_id: 'Irrigation-Controller-1', 
                timestamp: new Date().toISOString()
            };

            fetch(SPRINKLER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-System-Source': 'Sprinkler-Tester' },
                body: JSON.stringify(actionPayload)
            })
            .then(response => {
                if (response.ok) {
                    log(`SPRINKLER: SUCCESS [${state}] sent to Beeceptor. HTTP ${response.status}`);
                    sprinklerState = state; 
                    updateSprinklerStatusDisplay(state); 
                    
                    // ðŸš¨ Trigger Email Alert for critical ON status
                    if (state === 'ON') { 
                         sendEmailAlert('Irrigation System', state, `Rainfall is critically low at ${rainfall.toFixed(2)} in.`);
                    }

                } else {
                    log(`SPRINKLER: ERROR [${state}] failed. HTTP ${response.status}.`, true);
                }
                return response.json();
            })
            .then(data => { log(`SPRINKLER: Mock Response: ${JSON.stringify(data)}`); })
            .catch(error => { log(`SPRINKLER: Network Error: ${error.message}`, true); });
        }
        
        // --- SYSTEM CHECK & MASTER CONTROL (same as before) ---

        function checkGreenhouseTemp() {
            const simulatedTemp = 75 + Math.random() * 20; 
            currentTempEl.textContent = simulatedTemp.toFixed(1);
            
            currentTempEl.classList.toggle('text-red-400', simulatedTemp > TEMP_THRESHOLD);
            currentTempEl.classList.toggle('text-blue-400', simulatedTemp <= TEMP_THRESHOLD);

            let newFanState = (simulatedTemp > TEMP_THRESHOLD) ? 'ON' : 'OFF';

            if (newFanState !== fanState) {
                log(`FAN Logic: State change detected! Temp: ${simulatedTemp.toFixed(1)}Â°F.`);
                sendFanCommand(newFanState, simulatedTemp);
            }
        }

        function checkSprinklers() {
            const simulatedRainfall = Math.random(); 
            currentRainfallEl.textContent = simulatedRainfall.toFixed(2);
            
            currentRainfallEl.classList.toggle('text-green-400', simulatedRainfall > RAINFALL_THRESHOLD);
            currentRainfallEl.classList.toggle('text-blue-400', simulatedRainfall <= RAINFALL_THRESHOLD);

            let newSprinklerState = (simulatedRainfall < RAINFALL_THRESHOLD) ? 'ON' : 'OFF';

            if (newSprinklerState !== sprinklerState) {
                log(`SPRINKLER Logic: State change detected! Rain: ${simulatedRainfall.toFixed(2)} in.`);
                sendSprinklerCommand(newSprinklerState, simulatedRainfall);
            }
        }
        
        function checkAllSystems() {
            log('Running full system check...');
            checkGreenhouseTemp();
            checkSprinklers();
        }

        function toggleApiTest() {
            if (intervalId) {
                // Stop the test
                clearInterval(intervalId);
                intervalId = null;
                toggleButton.textContent = 'Start API Test';
                toggleButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700');
                log('--- API Test Stopped by User. ---');
            } else {
                // Start the test
                log('--- API Test Started by User. Checking all systems every 5 seconds... ---');
                checkAllSystems();
                intervalId = setInterval(checkAllSystems, CHECK_INTERVAL);
                toggleButton.textContent = 'Stop API Test';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleButton.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        // Initialize the page
        window.onload = () => {
            toggleButton.addEventListener('click', toggleApiTest);
            updateFanStatusDisplay(fanState); 
            updateSprinklerStatusDisplay(sprinklerState); 
        };
    </script>
</body>
</html>
