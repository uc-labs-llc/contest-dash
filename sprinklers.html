<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigation Control System 1.0 (BETA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 1. Full-Screen Background Fix */
        body {
            /* --- CHANGE MADE HERE --- 
               If your image is in the same folder as this HTML file: url('images/sky.jpg')
            */
            background-image: url('images/sky.jpg'); 
            
            /* FIX 1: Stop the image from repeating */
            background-repeat: no-repeat;
            
            /* FIX 2: Ensure the image covers the entire viewport */
            background-size: cover;
            
            /* FIX 3: Center the image and keep it fixed */
            background-position: center;
            background-attachment: fixed;
            
            font-family: 'Tahoma', sans-serif;
            overflow: hidden; /* Prevent scrollbar from the simulation */
            height: 100vh;
            width: 100vw;
        }
        
        /* Window Styling */
        .win-box {
            background-color: #ECE9D8;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            box-shadow: 1px 1px #000;
        }

        /* Title Bar */
        .win-title-bar {
            background: linear-gradient(90deg, #005A9C, #2E86C1);
            color: white;
            padding: 2px 4px;
            cursor: move;
            font-weight: bold;
            border-bottom: 1px solid #005A9C;
        }

        /* Status LEDs */
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #000;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.5);
            transition: background-color 0.3s;
        }

        .led-off {
            background-color: #FF6961; /* Red */
        }

        .led-on {
            background-color: #77DD77; /* Green */
            box-shadow: 0 0 5px #77DD77, inset 0 0 3px #fff;
        }

        /* Sprinkler Simulation */
        .sprinkler-head {
            position: absolute;
            bottom: 50px;
            width: 200px; /* INCREASED SIZE */
            height: 200px; /* INCREASED SIZE */
            color: #5B5B5B;
        }

        .sprinkler-head svg {
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.4));
        }

        .sprinkler-head.active {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Water Drop Simulation */
        .drop {
            position: absolute;
            background-color: #1a4f8f; /* DARK BLUE */
            border-radius: 50%;
            opacity: 1.0; 
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 5px rgba(26, 79, 143, 0.8); 
        }

        @keyframes spray {
            0% { 
                transform: translate(0, 0) scale(0.2); 
                filter: blur(1px);
            }
            100% { 
                /* The custom CSS variables --x and --y define the spray arc */
                transform: translate(var(--x), var(--y)) scale(1); 
                opacity: 0; 
                filter: blur(0px);
            }
        }
        
        /* Chart specific styling */
        .chart-container {
            width: 100%;
            height: 200px;
            margin-bottom: 1.5rem;
            padding: 8px;
            background-color: #f7f7f7;
            border: 1px solid #c0c0c0;
        }
        
    </style>
</head>
<body class="p-8">
    
    <div id="controller-panel" class="win-box w-full lg:w-[400px] fixed top-8 left-8 z-20">
        
        <div class="win-title-bar flex justify-between items-center">
            <span>Irrigation Control Panel - Water Conservation Mode</span>
            <div class="flex space-x-1">
                <button class="text-xs w-4 h-4 bg-gray-300 text-black border-2 border-t-white border-l-white border-r-black border-b-black">_</button>
                <button class="text-xs w-4 h-4 bg-gray-300 text-black border-2 border-t-white border-l-white border-r-black border-b-black">â–¡</button>
                <button class="text-xs w-4 h-4 bg-gray-300 text-black border-2 border-t-white border-l-white border-r-black border-b-black">X</button>
            </div>
        </div>

        <div class="p-6">
            <h1 class="text-lg font-bold mb-4 text-center text-blue-800">Automated Sprinkler Override Status</h1>
            
            <div class="win-box p-4 mb-6">
                <p class="text-sm mb-2 font-bold text-blue-800">Day of Week Scheduling:</p>
                <div class="flex flex-wrap justify-between items-center mb-4">
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="day-0" value="0" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="day-0" class="text-xs">Sun</label>
                    </div>
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="day-1" value="1" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="day-1" class="text-xs">Mon</label>
                    </div>
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="day-2" value="2" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="day-2" class="text-xs">Tue</label>
                    </div>
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="day-3" value="3" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="day-3" class="text-xs">Wed</label>
                    </div>
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="day-4" value="4" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="day-4" class="text-xs">Thu</label>
                    </div>
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="day-5" value="5" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="day-5" class="text-xs">Fri</label>
                    </div>
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="day-6" value="6" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="day-6" class="text-xs">Sat</label>
                    </div>
                </div>
                <p class="text-sm mb-2">Configure Water Conservation Threshold:</p>
                <div class="flex items-center space-x-4">
                    <label for="threshold" class="text-sm">Threshold (in.):</label>
                    <input type="number" id="threshold" value="0.5" step="0.1" class="win-box p-1 w-20 text-right text-black">
                    <span class="text-xs text-gray-600">(Manual Override)</span>
                </div>
                <p class="text-sm mt-4">Current Total Rainfall Input (from Dashboard Data):</p>
                <div class="flex items-center space-x-4">
                    <label for="rainfall" class="text-sm">Total Rainfall (in.):</label>
                    <input type="number" id="rainfall" value="0.2" step="0.1" class="win-box p-1 w-20 text-right text-black">
                    <span class="text-xs text-red-700 font-bold" id="manualInputStatus">* Manual Input Required</span>
                </div>
                
                <p class="text-sm mt-4 font-bold text-blue-800">Sprinkler Cost & Usage Configuration:</p>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center space-x-4">
                        <label for="costPerGallon" class="text-sm w-36">Cost per Gallon ($):</label>
                        <input type="number" id="costPerGallon" value="0.005" step="0.001" class="win-box p-1 w-20 text-right text-black">
                    </div>
                    <div class="flex items-center space-x-4">
                        <label for="flowRate" class="text-sm w-36">Flow Rate (GPM):</label>
                        <input type="number" id="flowRate" value="10" step="1" class="win-box p-1 w-20 text-right text-black">
                    </div>
                </div>
            </div>

            <div class="flex justify-center mb-6">
                <button id="checkButton" class="bg-gray-300 hover:bg-gray-400 text-black py-1 px-4 text-sm font-semibold 
                                            border-t-white border-l-white border-r-black border-b-black border-2 shadow-md
                                            active:border-t-black active:border-l-black active:border-r-white active:border-b-white">
                    Check Rainfall & Activate
                </button>
            </div>

            <div class="win-box p-4 bg-yellow-100 mb-6 border-yellow-500 border-2">
                <h2 class="font-bold mb-2 text-yellow-700">Running Cost Simulator:</h2>
                <p class="text-base font-mono">Total Gallons Used: <span id="gallonsUsed" class="font-bold text-blue-800">0.00</span> gal</p>
                <p class="text-base font-mono">Total Running Cost: <span id="totalCostDisplay" class="font-bold text-red-700">$0.000</span></p>
            </div>
            
            <div class="win-box p-4 bg-gray-200">
                <h2 class="font-bold mb-2">System Status:</h2>
                <div class="flex items-center space-x-4">
                    <div id="sprinklerLed" class="led led-off"></div>
                    <p id="statusMessage" class="font-semibold text-lg text-red-600">Awaiting Check...</p>
                </div>
                <p id="systemOutput" class="text-xs mt-2 text-gray-700"></p>
            </div>
        </div>
    </div>
    
    <div id="charts-panel" class="win-box w-full lg:w-[400px] fixed top-8 right-8 z-20">
        <div class="win-title-bar flex justify-between items-center">
            <span>Real-Time Telemetry Data (Usage)</span>
            <div class="flex space-x-1">
                <button class="text-xs w-4 h-4 bg-gray-300 text-black border-2 border-t-white border-l-white border-r-black border-b-black">_</button>
                <button class="text-xs w-4 h-4 bg-gray-300 text-black border-2 border-t-white border-l-white border-r-black border-b-black">â–¡</button>
                <button class="text-xs w-4 h-4 bg-gray-300 text-black border-2 border-t-white border-l-white border-r-black border-b-black">X</button>
            </div>
        </div>
        
        <div class="p-4">
            <h2 class="text-md font-bold mb-4 text-center text-blue-800">Irrigation Consumption Trend</h2>
            
            <div class="chart-container">
                <canvas id="gallonsChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
        </div>
    </div>

    
    <div id="sprinkler1" class="sprinkler-head" style="left: 20%; top: 75%;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.25 10.5C11.25 10.5 11.25 11.25 11.25 12C11.25 12.75 11.25 13.5 11.25 13.5H12.75C12.75 13.5 12.75 12.75 12.75 12C12.75 11.25 12.75 10.5 12.75 10.5H11.25Z" fill="#3B82F6"/>
            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6.75a.75.75 0 0 0 1.5 0V6ZM17.25 12a.75.75 0 0 1-.75.75H6a.75.75 0 0 1 0-1.5h10.5a.75.75 0 0 1 .75.75Z" clip-rule="evenodd" />
        </svg>
    </div>

    <div id="sprinkler2" class="sprinkler-head" style="right: 15%; top: 75%;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.25 10.5C11.25 10.5 11.25 11.25 11.25 12C11.25 12.75 11.25 13.5 11.25 13.5H12.75C12.75 13.5 12.75 12.75 12.75 12C12.75 11.25 12.75 10.5 12.75 10.5H11.25Z" fill="#3B82F6"/>
            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6.75a.75.75 0 0 0 1.5 0V6ZM17.25 12a.75.75 0 0 1-.75.75H6a.75.75 0 0 1 0-1.5h10.5a.75.75 0 0 1 .75.75Z" clip-rule="evenodd" />
        </svg>
    </div>

<script>
    // --- STATE VARIABLES & CONFIGURATION ---
    const EMAIL_RECIPIENT = 'your mail address'; 
    // Pointing to the dedicated PHP file
    const PHP_ENDPOINT_URL = 'send_sprinkler_email.php'; 
    
    let intervalId = null; 
    let costIntervalId = null; 
    let totalGallonsUsed = 0;
    const RECURRING_CHECK_INTERVAL_MS = 60000; // Check every 60 seconds

    // --- CHART DATA ARRAYS ---
    let timeLabels = [];
    let gallonsData = [];
    let costData = [];
    let gallonsChart;
    let costChart;
    // ---------------------------------------------------

    // --- DOM REFERENCES ---
    const thresholdInput = document.getElementById('threshold');
    const rainfallInput = document.getElementById('rainfall');
    const checkButton = document.getElementById('checkButton');
    const sprinklerLed = document.getElementById('sprinklerLed');
    const statusMessage = document.getElementById('statusMessage');
    const systemOutput = document.getElementById('systemOutput');
    const manualInputStatus = document.getElementById('manualInputStatus');
    const sprinklerHeads = [
        document.getElementById('sprinkler1'),
        document.getElementById('sprinkler2')
    ];
    // COST SIMULATOR REFERENCES
    const costPerGallonInput = document.getElementById('costPerGallon');
    const flowRateInput = document.getElementById('flowRate');
    const gallonsUsedDisplay = document.getElementById('gallonsUsed');
    const totalCostDisplay = document.getElementById('totalCostDisplay');
    // Day of Week Checkboxes
    const dayCheckboxes = [0, 1, 2, 3, 4, 5, 6].map(day => document.getElementById(`day-${day}`));

    
    /**
     * Sends an email notification by making an HTTP POST request to the server-side PHP script.
     */
    function sendSprinklerActivationEmail(rainfall, threshold) {
        let weatherMetrics = {};
        try {
            // Get the comprehensive weather report object from index.html's localStorage
            const metricsJson = localStorage.getItem('dashboardWeatherMetrics');
            if (metricsJson) {
                weatherMetrics = JSON.parse(metricsJson);
            }
        } catch (e) {
            console.error("Could not parse dashboardWeatherMetrics from localStorage:", e);
            systemOutput.textContent += ' [NOTIFICATION: Local storage weather data corrupt.]';
        }

        const payload = {
            recipient: EMAIL_RECIPIENT,
            rainfall: rainfall.toFixed(2),
            threshold: threshold.toFixed(2),
            weather_report: weatherMetrics 
        };
        
        fetch(PHP_ENDPOINT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', 
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                systemOutput.textContent += ' [NOTIFICATION: Email API SUCCESS! Check inbox.]';
            } else {
                systemOutput.textContent += ` [NOTIFICATION: Email API FAILED: ${data.message}]`;
            }
        })
        .catch(error => {
            console.error('Email Fetch/Server Error:', error);
            systemOutput.textContent += ' [NOTIFICATION: Email API ERROR! Check console/PHP server configuration.]';
        });
    }


    /**
     * Initializes the two Chart.js graphs on the right panel.
     */
    function initializeCharts() {
        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, 
            scales: {
                x: {
                    display: true,
                    title: { display: true, text: 'Time' },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            },
            plugins: {
                legend: { display: false },
                title: { display: true }
            }
        };

        gallonsChart = new Chart(document.getElementById('gallonsChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Gallons Used (gal)',
                    data: gallonsData,
                    borderColor: '#3B82F6', 
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 2
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: { ...defaultChartOptions.plugins, title: { display: true, text: 'Water Usage (Gallons)' } },
                scales: { 
                    ...defaultChartOptions.scales, 
                    y: { ...defaultChartOptions.scales.y, title: { display: true, text: 'Gallons' } } 
                }
            }
        });

        costChart = new Chart(document.getElementById('costChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Running Cost ($)',
                    data: costData,
                    borderColor: '#EF4444', 
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 2
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: { ...defaultChartOptions.plugins, title: { display: true, text: 'Running Cost (USD)' } },
                scales: { 
                    ...defaultChartOptions.scales, 
                    y: { ...defaultChartOptions.scales.y, title: { display: true, text: 'Cost ($)' } } 
                }
            }
        });
    }


    /**
     * Creates and animates a single "water drop" element.
     */
    function createDrop(origin) {
        const drop = document.createElement('div');
        drop.classList.add('drop');

        const size = Math.random() * 8 + 5; 
        drop.style.width = `${size}px`;
        drop.style.height = `${size}px`;

        const rect = origin.getBoundingClientRect();
        
        const startX = rect.left + rect.width / 2 + (Math.random() * 10 - 5);
        const startY = rect.top + rect.height / 2;
        
        drop.style.left = `${startX}px`; 
        drop.style.top = `${startY}px`;

        drop.style.transform = 'translate(0, 0) scale(0.2)';
        
        const maxHorizontalRange = rect.width * 1.5; 
        const maxVerticalRange = rect.height * 1.5; 

        let targetX;
        if (origin.style.left) { 
            targetX = (Math.random() * 0.7 + 0.3) * maxHorizontalRange * (Math.random() < 0.5 ? 1 : -0.5); 
        } else { 
            targetX = -(Math.random() * 0.7 + 0.3) * maxHorizontalRange * (Math.random() < 0.5 ? 1 : -0.5); 
        }

        let targetY = (Math.random() * maxVerticalRange * 0.5); 
        targetY += (Math.random() * 20 - 10);

        drop.style.setProperty('--x', `${targetX}px`);
        drop.style.setProperty('--y', `${targetY}px`);
        drop.style.animation = `spray ${Math.random() * 0.75 + 0.75}s ease-out forwards`; 

        document.body.appendChild(drop);

        drop.addEventListener('animationend', () => {
            drop.remove();
        });
    }

    /**
     * Sends the current usage and cost data back to the dashboard using localStorage.
     */
    function reportUsageToDashboard(gallons, cost) {
        localStorage.setItem('sprinklerGallonsUsed', gallons.toFixed(2));
        localStorage.setItem('sprinklerTotalCost', cost.toFixed(3));
    }

    /**
     * Calculates and updates the running cost of the system.
     */
    function calculateCost() {
        // Only run if the sprinklers are active
        if (!sprinklerLed.classList.contains('led-on')) {
            // Stop cost tracking if sprinklers are off
            if (costIntervalId) {
                clearInterval(costIntervalId);
                costIntervalId = null;
            }
            return;
        }

        const costPerGallon = parseFloat(costPerGallonInput.value) || 0.005;
        const flowRateGPM = parseFloat(flowRateInput.value) || 10;
        
        const timeElapsedSeconds = 1; 
        const gallonsUsedInSecond = flowRateGPM * (1 / 60) * timeElapsedSeconds;

        totalGallonsUsed += gallonsUsedInSecond;
        const currentTotalCost = totalGallonsUsed * costPerGallon;

        // Update display and charts
        gallonsUsedDisplay.textContent = totalGallonsUsed.toFixed(2);
        totalCostDisplay.textContent = `$${currentTotalCost.toFixed(3)}`; 
        
        const now = new Date();
        timeLabels.push(now.toLocaleTimeString());
        gallonsData.push(totalGallonsUsed);
        costData.push(currentTotalCost);
        
        const maxDataPoints = 30;
        if (timeLabels.length > maxDataPoints) {
            timeLabels.shift();
            gallonsData.shift();
            costData.shift();
        }

        if (gallonsChart) gallonsChart.update();
        if (costChart) costChart.update();

        // Push data to the dashboard's storage
        reportUsageToDashboard(totalGallonsUsed, currentTotalCost);
    }


    /**
     * Starts the continuous sprinkler simulation and cost tracking.
     */
    function startSprinklers() {
        // If already running, do nothing
        if (intervalId) return; 

        sprinklerHeads.forEach(head => head.classList.add('active'));
        
        // Start water spray simulation
        intervalId = setInterval(() => {
            sprinklerHeads.forEach(head => {
                createDrop(head);
            });
        }, 15); 
        
        // Start cost tracking if not already running
        if (!costIntervalId) {
            costIntervalId = setInterval(calculateCost, 1000); 
            systemOutput.textContent += ' Cost tracking started.';
        }
    }

    /**
     * Stops the continuous sprinkler simulation and cost tracking.
     */
    function stopSprinklers() {
        sprinklerHeads.forEach(head => head.classList.remove('active'));
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }

        // Cost tracking will stop itself on the next calculateCost interval
        
        // Final report usage update
        reportUsageToDashboard(totalGallonsUsed, totalGallonsUsed * (parseFloat(costPerGallonInput.value) || 0));
    }


    /**
     * Main logic to check rainfall and update status. 
     * @param {boolean} skipActivation - If true, the system checks status but does not call startSprinklers().
     */
    function checkSprinklers(skipActivation = false) { // MODIFIED: Added optional parameter
        // --- 1. Get Rainfall Data ---
        const thresholdValue = parseFloat(thresholdInput.value) || 0.5; 
        thresholdInput.value = thresholdValue.toFixed(1);

        let rainfallTextFromStorage = localStorage.getItem('dashboardTotalRainfall');
        let rainfallValue;
        let outputMessages = []; 

        // Attempt to pull data from the main dashboard
        if (rainfallTextFromStorage) {
            const numericMatch = rainfallTextFromStorage.match(/(\d+\.?\d*)/);
            if (numericMatch) {
                rainfallValue = parseFloat(numericMatch[1]);
                rainfallInput.value = rainfallValue.toFixed(2); 
                
                manualInputStatus.textContent = ' (Auto-loaded from Dashboard)';
                manualInputStatus.classList.remove('text-red-700');
                manualInputStatus.classList.add('text-green-700');
            } else {
                // Dashboard data found but is invalid/not numeric
                rainfallValue = parseFloat(rainfallInput.value);
                manualInputStatus.textContent = ' (* Manual Input Required: Dashboard data invalid)';
                manualInputStatus.classList.remove('text-green-700');
                manualInputStatus.classList.add('text-red-700');
            }
        } else {
            // No Dashboard data found, rely on manual input
            rainfallValue = parseFloat(rainfallInput.value);
            manualInputStatus.textContent = ' (* Manual Input Required: No Dashboard data found)';
            manualInputStatus.classList.remove('text-green-700');
            manualInputStatus.classList.add('text-red-700');
        }

        if (isNaN(rainfallValue) || rainfallValue < 0) {
            statusMessage.textContent = 'ERROR: Invalid Rainfall Data.';
            statusMessage.classList.add('text-red-600');
            statusMessage.classList.remove('text-green-600', 'text-blue-600');
            systemOutput.textContent = 'Please ensure index.html is loaded and enter a valid, non-negative number.';
            stopSprinklers();
            sprinklerLed.classList.remove('led-on');
            sprinklerLed.classList.add('led-off');
            return;
        }

        // --- 2. Check Day of Week Override ---
        const today = new Date().getDay(); 
        const dayCheckbox = dayCheckboxes[today];
        const isDayAllowed = dayCheckbox ? dayCheckbox.checked : false;

        if (!isDayAllowed) {
            stopSprinklers();
            statusMessage.textContent = 'STATUS: Sprinklers OFFLINE (Scheduled)';
            statusMessage.classList.add('text-blue-600');
            statusMessage.classList.remove('text-red-600', 'text-green-600');
            
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayName = dayNames[today];
            systemOutput.textContent = `Schedule override: Today (${todayName}) is disabled. Irrigation system safely disabled.`;
            sprinklerLed.classList.remove('led-on');
            sprinklerLed.classList.add('led-off');
            return; 
        } else {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            outputMessages.push(`Schedule: Today (${dayNames[today]}) is enabled.`);
        }

        // --- 3. Check Rainfall Threshold ---
        if (rainfallValue < thresholdValue) {
            
            // --- CRITICAL CHANGE: Check if activation should be skipped ---
            if (skipActivation) {
                 stopSprinklers(); // Ensure sprinklers are off during the initial load check
                 statusMessage.textContent = 'STATUS: Monitoring (Activation Pending)';
                 statusMessage.classList.add('text-blue-600');
                 statusMessage.classList.remove('text-red-600', 'text-green-600');
                 outputMessages.push(`Rainfall is below threshold, but activation is **SKIPPED** during initial load.`);
                 systemOutput.textContent = outputMessages.join(' ');
                 sprinklerLed.classList.remove('led-on');
                 sprinklerLed.classList.add('led-off');
                 return; // EXIT HERE on initial load
            }
            
            // ACTIVATE SPRINKLERS (Only if skipActivation is false - i.e., button click or recurring check)
            startSprinklers();
            
            // Only send an email if the system was NOT already running (prevent spam)
            if (!sprinklerLed.classList.contains('led-on')) {
                 sendSprinklerActivationEmail(rainfallValue, thresholdValue);
            }
            
            statusMessage.textContent = 'STATUS: Sprinklers ACTIVATED!';
            statusMessage.classList.add('text-green-600');
            statusMessage.classList.remove('text-red-600', 'text-blue-600');
            
            outputMessages.push(`Rainfall (${rainfallValue.toFixed(2)} in.) is below threshold (${thresholdValue.toFixed(2)} in.). Irrigation initiated. Cost tracking started and reporting to Dashboard.`);
            systemOutput.textContent = outputMessages.join(' ');

            sprinklerLed.classList.add('led-on');
            sprinklerLed.classList.remove('led-off');

        } else {
            // DO NOT ACTIVATE SPRINKLERS - Rainfall Saturated
            stopSprinklers();
            statusMessage.textContent = 'STATUS: Sprinklers OFFLINE (Saturated)';
            statusMessage.classList.add('text-blue-600');
            statusMessage.classList.remove('text-red-600', 'text-green-600');
            
            outputMessages.push(`Rainfall (${rainfallValue.toFixed(2)} in.) is sufficient. Irrigation system safely disabled.`);
            systemOutput.textContent = outputMessages.join(' ');
            
            sprinklerLed.classList.remove('led-on');
            sprinklerLed.classList.add('led-off');
        }
    }

    // Event Listener for Manual Check
    // When the button is clicked, skipActivation is UNDEFINED (which defaults to false)
    checkButton.addEventListener('click', () => checkSprinklers(false)); 
    
    // Initial and Recurring Auto-Check
    window.onload = () => {
        // 1. Initialize Charts
        initializeCharts();
        
        // 2. Set an initial status message immediately (Awaiting data/check)
        statusMessage.textContent = 'STATUS: Awaiting Initial Check...';
        statusMessage.classList.remove('text-green-600', 'text-red-600');
        statusMessage.classList.add('text-blue-600');
        
        // 3. Set up a short, randomized delay for the *first* check (1 to 4 seconds)
        const initialDelay = Math.random() * 3000 + 1000; 
        
        console.log(`Sprinkler system initialization complete. Starting first automated check in ${initialDelay.toFixed(0)}ms.`);

        setTimeout(() => {
            // CRITICAL CHANGE: Run the first check with skipActivation = TRUE
            checkSprinklers(true); 
            
            // 4. Set up the regular recurring check. This will use the default (false) for skipActivation.
            setInterval(() => checkSprinklers(false), RECURRING_CHECK_INTERVAL_MS); 
        }, initialDelay);
    }
</script>
</body>
</html>
